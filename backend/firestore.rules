rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================================
    // Isolamento Multi-tenant n.Risk
    // Um usuário só pode ler/escrever se auth.token.tenant_id == {tenantId}
    // ==========================================================================

    // Helper: verifica se o usuário pertence ao tenant do caminho
    function isTenantMember(tenantId) {
      return request.auth != null
        && request.auth.token.tenant_id == tenantId;
    }

    // Helper: validação de schema para score (0-1000)
    function isValidScore(score) {
      return score is number
        && score >= 0
        && score <= 1000;
    }

    // Helper: validação de empresa_dominio ou domain (string não vazia)
    function isValidDominio(dominio) {
      return dominio is string
        && dominio.size() > 0;
    }

    // ==========================================================================
    // Trust Center: leitura pública condicional
    // /tenants/{tenantId}/public_profile/{profileId} — apenas se is_public: true
    // ==========================================================================
    match /tenants/{tenantId}/public_profile/{profileId} {
      allow read: if resource != null
        && resource.data.is_public == true;
      allow write: if isTenantMember(tenantId);
    }

    // ==========================================================================
    // Scans: /tenants/{tenantId}/scans/{scanId}
    // Valida score (0-1000) e domain/empresa_dominio (string) no write
    // ==========================================================================
    match /tenants/{tenantId}/scans/{scanId} {
      allow read, delete: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId)
        && (!request.resource.data.keys().hasAny(['score']) || isValidScore(request.resource.data.score))
        && (!request.resource.data.keys().hasAny(['domain']) || isValidDominio(request.resource.data.domain))
        && (!request.resource.data.keys().hasAny(['empresa_dominio']) || isValidDominio(request.resource.data.empresa_dominio));
      allow update: if isTenantMember(tenantId)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['score']) || isValidScore(request.resource.data.score))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['domain']) || isValidDominio(request.resource.data.domain))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['empresa_dominio']) || isValidDominio(request.resource.data.empresa_dominio));
    }

    // ==========================================================================
    // Findings: tenants/{tenantId}/scans/{scanId}/findings/{findingId} (Scan Engine)
    // ==========================================================================
    match /tenants/{tenantId}/scans/{scanId}/findings/{findingId} {
      allow read, write: if isTenantMember(tenantId);
    }

    // ==========================================================================
    // Demais coleções sob /tenants/{tenantId}/...
    // Isolamento rigoroso por tenant_id
    // ==========================================================================
    match /tenants/{tenantId}/{document=**} {
      allow read, write: if isTenantMember(tenantId);
    }

    // Bloqueia acesso a qualquer outro caminho
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
